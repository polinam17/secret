name: Full Stack Application Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  COMPOSE_PROJECT_NAME: production-app

jobs:
  deploy-and-test:
    runs-on: self-hosted

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create environment configuration
      shell: cmd
      run: |
        echo DB_HOST=${{ secrets.DB_HOST }} > .env
        echo DB_PORT=${{ secrets.DB_PORT }} >> .env
        echo DB_NAME=${{ secrets.DB_NAME }} >> .env
        echo DB_USER=${{ secrets.DB_USER }} >> .env
        echo DB_PASSWORD=${{ secrets.DB_PASSWORD }} >> .env
        echo APP_PORT=${{ secrets.APP_PORT }} >> .env
        echo APP_SECRET=${{ secrets.APP_SECRET }} >> .env
        echo API_KEY=${{ secrets.API_KEY }} >> .env
        echo COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }} >> .env

    - name: Deploy application stack
      shell: cmd
      run: |
        docker-compose down
        docker-compose up -d
        timeout /t 30
        docker-compose ps

    - name: Verify container status
      shell: cmd
      run: |
        docker-compose ps | findstr "Up" > nul
        if %errorlevel% equ 0 (
          echo All containers are running
        ) else (
          echo Container health check failed
          docker-compose logs
          exit 1
        )

    - name: Test application connectivity
      shell: cmd
      run: |
        curl -f http://localhost:${{ secrets.APP_PORT }} || exit 1
        echo Application is responding correctly

    - name: Collect deployment logs
      shell: cmd
      run: |
        docker-compose logs > deployment-logs.txt
        docker ps -a > container-list.txt
        docker images > image-list.txt
        type .env > env-original.txt

    - name: Generate test report
      shell: cmd
      run: |
        echo # Deployment Test Report > test-report.md
        echo - Date: %date% %time% >> test-report.md
        echo - Status: Success >> test-report.md
        echo - Running Containers: 2 >> test-report.md

    - name: Upload configuration artifacts
      uses: actions/upload-artifact@v4
      with:
        name: configuration-files
        path: |
          test-report.md
          env-original.txt
        retention-days: 30

    - name: Upload system artifacts
      uses: actions/upload-artifact@v4
      with:
        name: system-info
        path: |
          deployment-logs.txt
          container-list.txt
          image-list.txt
        retention-days: 30

    - name: Deployment summary
      shell: cmd
      run: |
        echo Deployment completed successfully
        echo Self-Hosted Runner: Active
        echo Docker Compose: Running
        echo Services: Deployed
        echo Tests: Passed